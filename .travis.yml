stages:
- test
- release
dist: xenial
jobs:
  include:
  - stage: test
    name: Go Tests
    language: go
    go:
    - 1.10.x
    - 1.11.x
    - 1.12.x
    - 1.x.x
    install:
    - sudo apt-get install -y libasound2-dev libwebkit2gtk-4.0-dev
    - go get github.com/jteeuwen/go-bindata/...
    script:
    - mkdir -p ./frontend/build/
    - touch ./frontend/build/dummy
    - go-bindata ./frontend/build/...
    - go build ./
    - go test ./...
  - stage: test
    name: JS Tests
    language: node_js
    node_js: '10'
    script:
    - cd frontend
    - npm i
    - CI=false npm run-script build
  - stage: release
    name: Release Linux
    language: go
    go: 1.11.x
    node_js: '10'
    install:
    - go get github.com/jteeuwen/go-bindata/...
    script:
    - go version
    - cd frontend
    - npm i
    - CI=false npm run-script build
    - cd ..
    - go-bindata ./frontend/build/...
    - "./release-linux.sh"
    deploy:
      provider: releases
      skip_cleanup: true
      api_key:
        secure: dFyeV770U1xWJLDRpkxagRe4Gp2hLNHMxt9SkdGa3VlvsScaRBlZmWXSoBbE0OxUuOhUHtNtK7KiJaU+XptM+Bml3CajHO07O8MpJSkq+xk9bzRe50ixFGVa//TOmE2ZvC8gtTOt6jzmSsbKWKGt15WqYs3ynWTniPz2S11ADUKKPUv+uMq6F8w0sS0uUf6TVkoxJOClKoBglgJdcFsdLIYtay6IZzV73bB5/hpJeRwj/Z+fbVmFnNmRxTyWyxB/gASFgWRVb9+rRhG2M+EAV7cB/wrRio6pXK1hFeYb2Mt2MMcNamkhAIw/PqokWOeKMrT6D0qP8AtathHBbCf7IhVvpSiNzoqTy6vQRW1F2/2RLqqm/zgy3eHL2x1XE0A54PRphZBAn3HwJHpdZ5LSYMTZkoLTkPYBevuReWUML6W0N9GTE7s1BzcBu21zktqqZaRWp4uJTKofPWvtf2lvUHXjJUWP1w3FZ6ImRnpX/SqfsN4KXGJomL22P6676261i5h+NCN8aB+yxIvwcQjXfA5ZA1gjwy+mflXA1Bi3alSaQ7HK+3PuqUo6/53ApQJJ+dCsc3qMvADSNeSO/Vli0daCSmG0Day5445algbOf36Kqev1iW7hB4tPXYjEmAcpT1hi5Rk2MCosZ69bNBml+irJ55u/jt4Df0I6P1wUfdU=
      files: ABCBoard_*
      on:
        repo: meyskens/ABCBoard
        tags: true
  - stage: release
    name: Release macOS
    language: go
    go: 1.11.x
    node_js: '10'
    os: osx
    install:
    - go get github.com/jteeuwen/go-bindata/...
    script:
    - cd frontend
    - npm i
    - CI=false npm run-script build
    - cd ..
    - "$GOPATH/bin/go-bindata ./frontend/build/..."
    - "./release-mac.sh"
    deploy:
      provider: releases
      skip_cleanup: true
      api_key:
        secure: dFyeV770U1xWJLDRpkxagRe4Gp2hLNHMxt9SkdGa3VlvsScaRBlZmWXSoBbE0OxUuOhUHtNtK7KiJaU+XptM+Bml3CajHO07O8MpJSkq+xk9bzRe50ixFGVa//TOmE2ZvC8gtTOt6jzmSsbKWKGt15WqYs3ynWTniPz2S11ADUKKPUv+uMq6F8w0sS0uUf6TVkoxJOClKoBglgJdcFsdLIYtay6IZzV73bB5/hpJeRwj/Z+fbVmFnNmRxTyWyxB/gASFgWRVb9+rRhG2M+EAV7cB/wrRio6pXK1hFeYb2Mt2MMcNamkhAIw/PqokWOeKMrT6D0qP8AtathHBbCf7IhVvpSiNzoqTy6vQRW1F2/2RLqqm/zgy3eHL2x1XE0A54PRphZBAn3HwJHpdZ5LSYMTZkoLTkPYBevuReWUML6W0N9GTE7s1BzcBu21zktqqZaRWp4uJTKofPWvtf2lvUHXjJUWP1w3FZ6ImRnpX/SqfsN4KXGJomL22P6676261i5h+NCN8aB+yxIvwcQjXfA5ZA1gjwy+mflXA1Bi3alSaQ7HK+3PuqUo6/53ApQJJ+dCsc3qMvADSNeSO/Vli0daCSmG0Day5445algbOf36Kqev1iW7hB4tPXYjEmAcpT1hi5Rk2MCosZ69bNBml+irJ55u/jt4Df0I6P1wUfdU=
      files: ABCBoard.app
      on:
        repo: meyskens/ABCBoard
        tags: trueA
  - stage: release
    name: Release Windows
    language: go
    go: 1.11.x
    node_js: '10'
    os: windows
    install:
    - choco install nodejs
    - go get github.com/jteeuwen/go-bindata/...
    script:
    - cd frontend
    - C:/Program\ Files/nodejs/npm i
    - C:/Program\ Files/nodejs/npm run-script build
    - cd ..
    - go-bindata ./frontend/build/...
    - go generate
    - go build -ldflags "-H windowsgui" -o abcboard.exe
    deploy:
      provider: releases
      skip_cleanup: true
      api_key:
        secure: dFyeV770U1xWJLDRpkxagRe4Gp2hLNHMxt9SkdGa3VlvsScaRBlZmWXSoBbE0OxUuOhUHtNtK7KiJaU+XptM+Bml3CajHO07O8MpJSkq+xk9bzRe50ixFGVa//TOmE2ZvC8gtTOt6jzmSsbKWKGt15WqYs3ynWTniPz2S11ADUKKPUv+uMq6F8w0sS0uUf6TVkoxJOClKoBglgJdcFsdLIYtay6IZzV73bB5/hpJeRwj/Z+fbVmFnNmRxTyWyxB/gASFgWRVb9+rRhG2M+EAV7cB/wrRio6pXK1hFeYb2Mt2MMcNamkhAIw/PqokWOeKMrT6D0qP8AtathHBbCf7IhVvpSiNzoqTy6vQRW1F2/2RLqqm/zgy3eHL2x1XE0A54PRphZBAn3HwJHpdZ5LSYMTZkoLTkPYBevuReWUML6W0N9GTE7s1BzcBu21zktqqZaRWp4uJTKofPWvtf2lvUHXjJUWP1w3FZ6ImRnpX/SqfsN4KXGJomL22P6676261i5h+NCN8aB+yxIvwcQjXfA5ZA1gjwy+mflXA1Bi3alSaQ7HK+3PuqUo6/53ApQJJ+dCsc3qMvADSNeSO/Vli0daCSmG0Day5445algbOf36Kqev1iW7hB4tPXYjEmAcpT1hi5Rk2MCosZ69bNBml+irJ55u/jt4Df0I6P1wUfdU=
      file: abcboard.exe
      on:
        repo: meyskens/ABCBoard
